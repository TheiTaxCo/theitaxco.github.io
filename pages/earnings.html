<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <title>Earnings — EarnRoute</title>
    <link rel="stylesheet" href="../style.css" />
    <script
      defer
      src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"
    ></script>
    <script src="https://code.iconify.design/iconify-icon/2.1.0/iconify-icon.min.js"></script>

    <script defer src="../assets/js/script.js"></script>
    <script type="module" src="../assets/js/config.supabase.js"></script>
    <script type="module" src="../assets/js/auth.supabase.js"></script>
    <script type="module">
      import { logoutUser } from "../assets/js/auth.supabase.js";
      window.__logoutUser = logoutUser;
    </script>

    <script type="module" src="../assets/js/db.supabase.js"></script>
    <script type="module" src="../assets/js/sync.supabase.js"></script>
    <script src="../assets/js/util.dom.js"></script>

    <!-- Component script -->
    <script type="module" src="../assets/js/components/mobile-tabs.js"></script>

    <!-- Authentication gate -->
    <script type="module">
      import { requireAuthOrRedirect } from "../assets/js/auth.supabase.js";
      requireAuthOrRedirect(); // kicks to login if not signed in
    </script>
  </head>
  <body>
    <!-- Fixed Header -->
    <header class="app-header">
      <button class="hamburger" aria-label="Menu">
        <span class="hamburger-bars"></span>
      </button>
      <div class="title">EarnRoute</div>
    </header>

    <!-- Scrollable Content (no action bar here) -->
    <main class="content no-actionbar">
      <div class="tabs-host" role="region" aria-label="Earnings filters">
        <er-mobile-tabs
          id="earningsTabs"
          options="Day,Week,Month"
          value="Day"
        ></er-mobile-tabs>
      </div>
      <br />

      <!-- DAY card -->
      <section class="card" id="earningsTotals">
        <h3 style="margin-bottom: 12px">Today's Earnings</h3>

        <!-- Accordion container -->
        <div class="earnings-accordion" id="earningsAccordion">
          <!-- Grubhub row -->
          <button
            class="ea-row"
            type="button"
            data-courier="grubhub"
            aria-expanded="false"
          >
            <div class="ea-left">
              <iconify-icon
                icon="simple-icons:grubhub"
                class="ea-brand"
              ></iconify-icon>
              <strong>Grubhub</strong>
            </div>
            <div class="ea-right">
              <!-- HEADER TOTAL (split into $ + int.dec) -->
              <span class="ea-amount">
                <span class="ea-currency">$</span>
                <span id="ea-gh-total" class="ea-value">
                  <span class="ea-int">0</span><span class="ea-dot">.</span
                  ><span class="ea-dec">00</span>
                </span>
              </span>
              <iconify-icon
                icon="mdi:chevron-down"
                class="ea-toggle"
              ></iconify-icon>
            </div>
          </button>

          <!-- Put all GH details back into a hidden wrapper so collapse works -->
          <div class="ea-details-inline" id="ea-gh-details" hidden>
            <div class="ea-detail-row">
              <span>Delivery Pay</span>
              <span class="ea-amount">
                <span class="ea-currency">$</span>
                <span id="ea-gh-delivery" class="ea-value">
                  <span class="ea-int">0</span><span class="ea-dot">.</span
                  ><span class="ea-dec">00</span>
                </span>
              </span>
            </div>
            <div class="ea-detail-row">
              <span>Tips</span>
              <span class="ea-amount">
                <span class="ea-currency">$</span>
                <span id="ea-gh-tips" class="ea-value">
                  <span class="ea-int">0</span><span class="ea-dot">.</span
                  ><span class="ea-dec">00</span>
                </span>
              </span>
            </div>
            <div class="ea-detail-row">
              <span>Adjustments</span>
              <span class="ea-amount">
                <span class="ea-currency">$</span>
                <span id="ea-gh-adj" class="ea-value">
                  <span class="ea-int">0</span><span class="ea-dot">.</span
                  ><span class="ea-dec">00</span>
                </span>
              </span>
            </div>
          </div>

          <hr class="ea-divider" />

          <!-- Uber Eats row -->
          <button
            class="ea-row"
            type="button"
            data-courier="ubereats"
            aria-expanded="false"
          >
            <div class="ea-left">
              <iconify-icon
                icon="simple-icons:ubereats"
                class="ea-brand"
              ></iconify-icon>
              <strong>Uber Eats</strong>
            </div>
            <div class="ea-right">
              <!-- HEADER TOTAL (split into $ + int.dec) -->
              <span class="ea-amount">
                <span class="ea-currency">$</span>
                <span id="ea-ue-total" class="ea-value">
                  <span class="ea-int">0</span><span class="ea-dot">.</span
                  ><span class="ea-dec">00</span>
                </span>
              </span>
              <iconify-icon
                icon="mdi:chevron-down"
                class="ea-toggle"
              ></iconify-icon>
            </div>
          </button>

          <!-- Match class + hidden like GH -->
          <div class="ea-details-inline" id="ea-ue-details" hidden>
            <div class="ea-detail-row">
              <span>Delivery Pay</span>
              <span class="ea-amount">
                <span class="ea-currency">$</span>
                <span id="ea-ue-delivery" class="ea-value">
                  <span class="ea-int">0</span><span class="ea-dot">.</span
                  ><span class="ea-dec">00</span>
                </span>
              </span>
            </div>
            <div class="ea-detail-row">
              <span>Tips</span>
              <span class="ea-amount">
                <span class="ea-currency">$</span>
                <span id="ea-ue-tips" class="ea-value">
                  <span class="ea-int">0</span><span class="ea-dot">.</span
                  ><span class="ea-dec">00</span>
                </span>
              </span>
            </div>
            <div class="ea-detail-row">
              <span>Adjustments</span>
              <span class="ea-amount">
                <span class="ea-currency">$</span>
                <span id="ea-ue-adj" class="ea-value">
                  <span class="ea-int">0</span><span class="ea-dot">.</span
                  ><span class="ea-dec">00</span>
                </span>
              </span>
            </div>
          </div>
        </div>

        <hr class="ea-divider" />

        <!-- Grand total (keeps your existing CSS `$` via ::before) -->
        <p class="earnings-row" style="margin-top: 8px">
          <strong>Grand Total:</strong>
          <span class="amount grand" id="grandTotal">0.00</span>
        </p>

        <div style="margin-top: 12px">
          <button id="openEarningsBtn" class="btn-primary">Earnings</button>
        </div>
      </section>

      <!-- WEEK card -->
      <section class="card" id="earningsWeekCard" hidden>
        <h3 style="margin-bottom: 30px">This Week's Earnings</h3>
        <p class="earnings-row">
          <strong>Grubhub Total:</strong>
          <span class="amount" id="ghWeekTotal" style="float: right"
            >$ 0.00</span
          >
        </p>
        <hr class="drawer-sep" />
        <p class="earnings-row">
          <strong>Uber Eats Total:</strong>
          <span class="amount" id="ueWeekTotal" style="float: right"
            >$ 0.00</span
          >
        </p>
        <hr class="drawer-sep" />
        <p class="earnings-row">
          <strong>Grand Total:</strong>
          <span
            class="amount grand"
            id="grandWeekTotal"
            style="float: right; font-weight: bold"
            >$ 0.00</span
          >
        </p>
        <div style="margin-top: 12px"></div>
      </section>
    </main>

    <!-- Slide-up Earnings Sheet -->
    <div id="earningsSheet" class="slide-up hidden">
      <div class="sheet-header">
        <h2>Earnings Summary</h2>
        <button id="closeEarningsBtn">&times;</button>
      </div>

      <h3>Grubhub</h3>
      <div class="form-row">
        <label for="deliveryPayGrubhub">Delivery Pay</label>
        <input
          type="text"
          id="deliveryPayGrubhub"
          inputmode="numeric"
          placeholder="0.00"
          class="money-input"
        />
      </div>
      <div class="form-row">
        <label for="tipsPayGrubhub">Tips</label>
        <input
          type="text"
          id="tipsPayGrubhub"
          inputmode="numeric"
          placeholder="0.00"
          class="money-input"
        />
      </div>
      <div class="form-row">
        <label for="adjustmentPayGrubhub">Adjustment Pay</label>
        <input
          type="text"
          id="adjustmentPayGrubhub"
          inputmode="numeric"
          placeholder="0.00"
          class="money-input"
        />
      </div>
      <div class="form-row">
        <label>Total Earnings</label>
        <span id="totalEarningsGrubhub" class="output-value">Pending</span>
      </div>

      <hr class="drawer-sep" />

      <h3>Uber Eats</h3>
      <div class="form-row">
        <label for="deliveryPayUber">Delivery Pay</label>
        <input
          type="text"
          id="deliveryPayUber"
          inputmode="numeric"
          placeholder="0.00"
          class="money-input"
        />
      </div>
      <div class="form-row">
        <label for="tipsPayUber">Tips</label>
        <input
          type="text"
          id="tipsPayUber"
          inputmode="numeric"
          placeholder="0.00"
          class="money-input"
        />
      </div>
      <div class="form-row">
        <label for="adjustmentPayUber">Adjustment Pay</label>
        <input
          type="text"
          id="adjustmentPayUber"
          inputmode="numeric"
          placeholder="0.00"
          class="money-input"
        />
      </div>
      <div class="form-row">
        <label>Total Earnings</label>
        <span id="totalEarningsUber" class="output-value">Pending</span>
      </div>

      <hr class="drawer-sep" />

      <div class="form-row">
        <label><strong>Grand Total</strong></label>
        <span id="grandTotalEarnings" class="output-value">Pending</span>
      </div>

      <div class="form-actions">
        <button id="calcEarningsBtn" class="btn-calculate">Calculate</button>
      </div>
    </div>

    <!-- Fixed Bottom Navigation -->
    <nav class="bottom-nav">
      <div class="nav-inner">
        <a class="nav-item" href="home.html">
          <i data-lucide="home"></i><span>Home</span>
        </a>
        <a class="nav-item" href="deliveries.html">
          <i data-lucide="utensils"></i><span>Deliveries</span>
        </a>
        <a class="nav-item" href="earnings.html">
          <i data-lucide="dollar-sign"></i><span>Earnings</span>
        </a>
        <a class="nav-item" href="more.html">
          <i data-lucide="more-horizontal"></i><span>More</span>
        </a>
      </div>
    </nav>
    <!-- One global backdrop per page -->
    <div id="modalBackdrop" class="backdrop"></div>

    <div id="customToast"></div>

    <!-- Left slide-in drawer -->
    <aside id="sideDrawer" class="drawer">
      <div class="drawer-header">
        <h3>George Moreno</h3>
        <button id="closeDrawerBtn" class="drawer-close" aria-label="Close">
          ×
        </button>
      </div>

      <div class="drawer-content">
        <a href="home.html" class="drawer-link">Home</a>
        <a href="deliveries.html" class="drawer-link">Deliveries</a>
        <a href="earnings.html" class="drawer-link">Earnings</a>
        <a href="more.html" class="drawer-link">More</a>

        <hr class="drawer-sep" />
        <button id="logoutBtn" class="drawer-logout">Logout</button>
        <p style="text-align: center">Version: 3.0.0</p>
      </div>
    </aside>

    <!--  Wire the tabs to the cards -->
    <!--  Wire the tabs to the cards -->
    <script type="module">
      import { sumWeeklyEarningsFromEarningsTable } from "../assets/js/db.supabase.js";

      const tabs = document.getElementById("earningsTabs");
      const dayCard = document.getElementById("earningsTotals");
      const weekCard = document.getElementById("earningsWeekCard");

      const $ = (id) => document.getElementById(id);

      // Local Mon→Sun of this week
      function mondayOfThisWeek(d = new Date()) {
        const day = d.getDay(); // 0=Sun..6=Sat
        const diffFromMon = (day + 6) % 7; // Mon=0
        const m = new Date(d);
        m.setHours(0, 0, 0, 0);
        m.setDate(d.getDate() - diffFromMon);
        return m;
      }
      function sundayOfThisWeek(d = new Date()) {
        const m = mondayOfThisWeek(d);
        const s = new Date(m);
        s.setDate(m.getDate() + 6);
        s.setHours(23, 59, 59, 999);
        return s;
      }
      function fmtYYYYMMDD(dt) {
        const pad = (n) => String(n).padStart(2, "0");
        return `${dt.getFullYear()}-${pad(dt.getMonth() + 1)}-${pad(
          dt.getDate()
        )}`;
      }

      async function refreshWeeklyCard() {
        const start = mondayOfThisWeek();
        const end = sundayOfThisWeek();
        try {
          const sums = await sumWeeklyEarningsFromEarningsTable(
            fmtYYYYMMDD(start),
            fmtYYYYMMDD(end)
          );

          const set$ = (id, val) => {
            const el = $(id);
            if (el) el.textContent = `$ ${(Number(val) || 0).toFixed(2)}`;
          };
          set$("ghWeekTotal", sums.grubhub);
          set$("ueWeekTotal", sums.ubereats);
          set$("grandWeekTotal", sums.grand);
        } catch (err) {
          console.warn("[Weekly totals] load failed:", err);
          ["ghWeekTotal", "ueWeekTotal", "grandWeekTotal"].forEach((id) => {
            const el = $(id);
            if (el) el.textContent = "$ 0.00";
          });
        }
      }

      function applyTab(value) {
        dayCard.hidden = true;
        weekCard.hidden = true;

        if (value === "Day") {
          dayCard.hidden = false;
        } else if (value === "Week") {
          weekCard.hidden = false;
          refreshWeeklyCard();
        }
        // "Month" => both hidden for now
      }

      // Initial render (based on default "Day")
      applyTab(tabs.value || tabs.getAttribute("value") || "Day");

      // Respond to user selection
      tabs.addEventListener("change", (e) => applyTab(e.detail.value));
    </script>
  </body>
</html>

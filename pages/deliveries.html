<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />
    <title>Deliveries — EarnRoute</title>
    <link rel="stylesheet" href="../style.css" />
    <script
      defer
      src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"
    ></script>
    <!--Iconify Wev Component-->
    <script src="https://code.iconify.design/iconify-icon/2.1.0/iconify-icon.min.js"></script>
    <!--javascripts-->
    <script defer src="../assets/js/script.js"></script>
    <script type="module" src="../assets/js/config.supabase.js"></script>
    <script type="module" src="../assets/js/auth.supabase.js"></script>
    <script type="module">
      import { logoutUser } from "../assets/js/auth.supabase.js";
      window.__logoutUser = logoutUser;
    </script>

    <script type="module" src="../assets/js/db.supabase.js"></script>
    <script type="module" src="../assets/js/sync.supabase.js"></script>
    <script src="../assets/js/util.dom.js"></script>

    <!-- ✅ Authentication gate -->
    <script type="module">
      import { requireAuthOrRedirect } from "../assets/js/auth.supabase.js";
      requireAuthOrRedirect(); // kicks to login if not signed in
    </script>

    <!-- Segmented Tabs (mobile pill style) — scoped styles -->
    <style>
      /* titles always readable */
      .group-title {
        color: #111827;
        opacity: 1 !important;
      }
      /* hide via hidden attr */
      [hidden] {
        display: none !important;
      }

      .tabs-host {
        margin: 10px 0 12px 0;
      }
      er-mobile-tabs {
        display: block;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <!-- Fixed Header -->
    <header class="app-header">
      <button class="hamburger" aria-label="Menu">
        <span class="hamburger-bars"></span>
      </button>
      <div class="title">EarnRoute</div>
    </header>

    <!-- Scrollable Content -->
    <main class="content">
      <!-- NEW: Mobile segmented tabs (Active / Completed) -->
      <div class="tabs-host" role="region" aria-label="Deliveries filters">
        <er-mobile-tabs
          id="deliveriesTabs"
          options="Active,Completed"
          value="Active"
        ></er-mobile-tabs>
      </div>
      <h2>Deliveries</h2>
      <p id="mealsSubtitle">mealSubtitle value.</p>

      <!-- ACTIVE group -->
      <h2 class="group-title" id="titleActive"></h2>
      <div id="checkboxGroupActive" class="checkbox-group"></div>

      <!-- COMPLETED group -->
      <h2 class="group-title" style="margin-top: 18px" id="titleCompleted"></h2>
      <div id="checkboxGroupCompleted" class="checkbox-group"></div>

      <!-- Slide-up: Meal details -->
      <div id="slideUpSheet" class="slide-up hidden">
        <div class="sheet-header">
          <h2 id="mealLabelInSheet"></h2>
          <button id="closeSheetBtn">&times;</button>
        </div>

        <p><strong>Accepted:</strong> <span id="acceptedTimeInSheet"></span></p>
        <p>
          <strong>Delivered:</strong> <span id="deliveredTimeInSheet"></span>
        </p>
        <p><strong>Duration:</strong> <span id="durationInSheet"></span></p>

        <!-- NEW: Courier chooser -->
        <div class="courier-chooser">
          <button
            id="btnCourierGH"
            class="courier-btn courier-gh"
            aria-pressed="false"
            type="button"
            title="Grubhub"
          >
            <iconify-icon
              icon="simple-icons:grubhub"
              aria-hidden="true"
            ></iconify-icon>
          </button>
          <button
            id="btnCourierUE"
            class="courier-btn courier-ue"
            aria-pressed="false"
            type="button"
            title="Uber Eats"
          >
            <iconify-icon
              icon="simple-icons:ubereats"
              aria-hidden="true"
            ></iconify-icon>
          </button>
        </div>

        <button class="btn-delivered" id="markDeliveredBtn" disabled>
          Delivered
        </button>
      </div>

      <!-- Toast -->
      <div id="customToast"></div>
    </main>

    <!-- Fixed action bar -->
    <div class="action-bar">
      <button id="addMealBtn" class="btn-primary">+ Add</button>
      <button id="resetBtn" class="btn-secondary">Reset All</button>
    </div>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
      <div class="nav-inner">
        <a class="nav-item" href="home.html"
          ><i data-lucide="home"></i><span>Home</span></a
        >
        <a class="nav-item" href="deliveries.html"
          ><i data-lucide="utensils"></i><span>Deliveries</span></a
        >
        <a class="nav-item" href="earnings.html"
          ><i data-lucide="dollar-sign"></i><span>Earnings</span></a
        >
        <a class="nav-item" href="more.html"
          ><i data-lucide="more-horizontal"></i><span>More</span></a
        >
      </div>
    </nav>

    <!-- Backdrop -->
    <div id="modalBackdrop" class="backdrop"></div>

    <!-- Left slide-in drawer -->
    <aside id="sideDrawer" class="drawer">
      <div class="drawer-header">
        <h3>George Moreno</h3>
        <button id="closeDrawerBtn" class="drawer-close" aria-label="Close">
          ×
        </button>
      </div>

      <div class="drawer-content">
        <a href="dashboard.html" class="drawer-link">Dashboard</a>
        <a href="home.html" class="drawer-link">Home</a>
        <a href="deliveries.html" class="drawer-link">Deliveries</a>
        <a href="earnings.html" class="drawer-link">Earnings</a>
        <a href="more.html" class="drawer-link">More</a>

        <hr class="drawer-sep" />
        <button id="logoutBtn" class="drawer-logout">Logout</button>
        <p style="text-align: center">Version: 3.0.0</p>
      </div>
    </aside>

    <!-- =========================
         Mobile Segmented Tabs (Web Component)
         ========================= -->
    <script type="module">
      /**
       * <er-mobile-tabs>
       * Pill-style segmented control for mobile.
       * Equal-width columns so pills match regardless of label length.
       */
      class ERMobileTabs extends HTMLElement {
        static get observedAttributes() {
          return ["options", "value", "disabled"];
        }
        constructor() {
          super();
          this.attachShadow({ mode: "open" });
          this.shadowRoot.innerHTML = `
            <style>
              :host {
                --track: #e5e7eb;      /* inactive track */
                --thumb: #ffffff;      /* active pill */
                --text: #111827;       /* active text */
                --muted: #6b7280;      /* inactive text */
                --radius: 6px;
                --pad: 2px;
                --height: 35px;
                --speed: 170ms;
                display: block;
              }
              .wrap {
                position: relative;
                background: var(--track);
                border-radius: calc(var(--radius) + 4px);
                padding: var(--pad);
                display: grid;
                grid-auto-flow: column;
                grid-template-columns: repeat(var(--count, 2), 1fr); /* ✅ equal columns */
                gap: 8px;
                box-shadow: inset 0 1px 0 rgba(0,0,0,.04);
              }
              /* pill behind text */
              .thumb {
                position: absolute;
                top: var(--pad);
                left: var(--pad);
                height: var(--height);
                width: var(--w, 120px);
                transform: translateX(var(--x, 0px));
                background: var(--thumb);
                border-radius: var(--radius);
                transition: transform var(--speed) ease, width var(--speed) ease;
                box-shadow: 0 1.5px 4px rgba(16,24,40,.12);
                will-change: transform, width;
                z-index: 0;
                pointer-events: none;
              }
              /* slotted buttons stretch to full cell width */
              ::slotted(button) {
                all: unset;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                width: 100%;            /* ✅ take full column width */
                height: var(--height);
                padding: 0 16px;
                border-radius: var(--radius);
                font-weight: 700;
                font-size: 15px;
                line-height: 1;
                cursor: pointer;
                color: var(--muted);
                position: relative;
                z-index: 1;             /* above thumb */
              }
              ::slotted(button[aria-selected="true"]) { color: var(--text); }
              :host([disabled]) { opacity:.6; pointer-events:none; }
            </style>
            <div class="wrap" role="tablist" aria-label="Delivery tabs">
              <div class="thumb" aria-hidden="true"></div>
              <slot></slot>
            </div>
          `;
          this._wrap = this.shadowRoot.querySelector(".wrap");
          this._thumb = this.shadowRoot.querySelector(".thumb");
          this._btns = [];
          this._ro = null;
          this._value = null;
        }
        connectedCallback() {
          this._buildIfNeeded();
          this._cache();
          this._bind();
          /* set the equal-column count based on # of buttons */
          this._wrap.style.setProperty(
            "--count",
            String(this._btns.length)
          ); /* ✅ added */

          const initial =
            this.getAttribute("value") ||
            this._btns[0]?.dataset.value ||
            this._btns[0]?.textContent.trim();
          this.select(initial, true);
          this._layout();

          this._ro = new ResizeObserver(() => this._layout());
          this._ro.observe(this);
        }
        disconnectedCallback() {
          this._ro && this._ro.disconnect();
        }
        attributeChangedCallback(n, o, v) {
          if (n === "options") {
            this._buildIfNeeded(true);
            this._cache();
            this._bind();
            this._wrap.style.setProperty(
              "--count",
              String(this._btns.length)
            ); /* keep in sync */
            this.select(
              this.getAttribute("value") || this._btns[0]?.dataset.value,
              true
            );
            this._layout();
          }
          if (n === "value") this.select(v);
        }
        get value() {
          return this._value;
        }
        set value(v) {
          this.setAttribute("value", v);
        }

        _buildIfNeeded(force = false) {
          const hasChildren = this.children.length > 0 && !force;
          if (hasChildren && !force) return;
          const list = (this.getAttribute("options") || "Active,Completed")
            .split(",")
            .map((s) => s.trim())
            .filter(Boolean);
          this.innerHTML = "";
          list.forEach((label, i) => {
            const b = document.createElement("button");
            b.type = "button";
            b.textContent = label;
            b.dataset.value = label;
            b.setAttribute("role", "tab");
            if (i === 0) b.setAttribute("aria-selected", "true");
            this.appendChild(b);
          });
        }
        _cache() {
          this._btns = [...this.querySelectorAll('button[role="tab"],button')];
        }
        _bind() {
          this._btns.forEach((btn) => {
            btn.onclick = () =>
              this.select(btn.dataset.value || btn.textContent.trim());
            btn.onkeydown = (e) => {
              const i = this._btns.indexOf(btn);
              if (e.key === "ArrowRight") {
                e.preventDefault();
                this._btns[(i + 1) % this._btns.length].click();
                this._btns[(i + 1) % this._btns.length].focus();
              }
              if (e.key === "ArrowLeft") {
                e.preventDefault();
                this._btns[
                  (i - 1 + this._btns.length) % this._btns.length
                ].click();
                this._btns[
                  (i - 1 + this._btns.length) % this._btns.length
                ].focus();
              }
            };
          });
        }
        select(v, silent = false) {
          const btn =
            this._btns.find(
              (b) => (b.dataset.value || b.textContent.trim()) === v
            ) || this._btns[0];
          this._btns.forEach((b) => b.setAttribute("aria-selected", "false"));
          btn.setAttribute("aria-selected", "true");
          this._value = btn.dataset.value || btn.textContent.trim();
          this._layout();
          if (!silent)
            this.dispatchEvent(
              new CustomEvent("change", {
                bubbles: true,
                detail: { value: this._value },
              })
            );
        }
        _layout() {
          if (!this._btns.length) return;
          const idx = this._btns.findIndex(
            (b) => b.getAttribute("aria-selected") === "true"
          );
          const rects = this._btns.map((b) => b.getBoundingClientRect());
          const x = rects[idx].left - rects[0].left;
          const w = rects[idx].width; /* now equal for all columns */
          this._wrap.style.setProperty("--x", x + "px");
          this._wrap.style.setProperty("--w", w + "px");
        }
      }
      customElements.define("er-mobile-tabs", ERMobileTabs);

      // Page wiring: toggle Active vs Completed sections
      (function () {
        const tabs = document.getElementById("deliveriesTabs");
        const titleA = document.getElementById("titleActive");
        const groupA = document.getElementById("checkboxGroupActive");
        const titleC = document.getElementById("titleCompleted");
        const groupC = document.getElementById("checkboxGroupCompleted");
        const subtitle = document.getElementById("mealsSubtitle");

        function apply(which) {
          const isActive = which === "Active";
          titleA.hidden = !isActive;
          groupA.hidden = !isActive;
          titleC.hidden = isActive;
          groupC.hidden = isActive;

          //Update the sentence
          if (subtitle) {
            subtitle.textContent = `Order ${
              isActive ? "Active" : "Completed"
            } List.`;
          }
        }

        apply(tabs.getAttribute("value") || "Active");
        tabs.addEventListener("change", (e) => apply(e.detail.value));
      })();
    </script>

    <!-- 🔧 Display-only tweak for Accepted time in slide-up sheet -->
    <script>
      // When a tile's ">" arrow is tapped, script.js opens the sheet and
      // sets #acceptedTimeInSheet to the tile's timestamp text, which may include
      // the prefix "Accepted on: ...". We strip that prefix so the sheet shows
      // "Accepted: <date/time>" without duplicating the word "Accepted".
      document.addEventListener("click", function (e) {
        if (e.target && e.target.classList.contains("arrow-btn")) {
          // Run after script.js updates the sheet contents
          setTimeout(() => {
            const span = document.getElementById("acceptedTimeInSheet");
            if (!span) return;
            const raw = span.textContent || "";
            const cleaned = raw.replace(/^Accepted on:\s*/i, "");
            span.textContent = cleaned || "Pending";
          }, 0);
        }
      });
    </script>
  </body>
</html>
